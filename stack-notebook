#!/usr/bin/env bash
set -e

## todo add advice about times and probabilities

## bashism: check if stack exists
if ! hash stack 2>/dev/null; then
cat <<- DELIM
Error:  stack does not appear to be installed on your system!

Please install it by following the instructions at:
https://docs.haskellstack.org/en/stable/install_and_upgrade/

Or on macOs with homebrew:
brew install haskell-stack

NOTE:
The first time you use stack, it takes a few minutes to install ghc,
and then _many_ minutes to build IHaskell.  Subsequent runs of
stack-notebook are likely to be much faster... (hopefully)
DELIM
exit 1
fi


project_root=$(stack path --project-root)
echo "Running stack-notebook for ${project_root}..."

#todo: get snapshot via `stack config get` when available
snapshot=$(basename "$(dirname "$(stack path --snapshot-install-root)")")
echo -e "Using snapshot ${snapshot}..."

stack_root=$(stack path --stack-root)
## create notebook work directory
notebook_dir=${stack_root}/.stack-notebook/${snapshot}
mkdir -p ${notebook_dir}

##conda
conda_dir=${notebook_dir}/conda
conda=${notebook_dir}/conda/bin/conda
if [ ! -d "${conda_dir}" ]; then
(
  cd ${notebook_dir}
  echo "Installing miniconda..."
  curl -O https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh
  sh Miniconda3-latest-MacOSX-x86_64.sh -b -f -p ${conda_dir}
)
fi

#jupyter
jupyter=${notebook_dir}/conda/bin/jupyter
if [ ! -f "${jupyter}" ]; then
(
  ${conda} install --yes jupyter=1.0.0 nbconvert=5.2.1
)
fi

## IHaskell
ihaskell_dir=${notebook_dir}/IHaskell
if [ ! -d "${ihaskell_dir}" ]; then
(
    cd ${notebook_dir}
    git clone https://github.com/habemus-papadum/IHaskell.git
)
fi

ihaskell=${notebook_dir}/bin/ihaskell
if [ ! -f "${ihaskell}" ]; then
(
  ## build
  cd ${notebook_dir}
  mkdir -p bin
  cd ${ihaskell_dir}
  stack install --resolver=${snapshot} --local-bin-path=${notebook_dir}/bin --fast

  ## install kernel spec (runs in stack)
  ${ihaskell} --install ## do NOT specify --stack
)
fi

export IHASKELL_GHC_PKB_DB=\
  $(stack path --snapshot-pkg-db)


stack exec bash -- -c <<- EOF
GHC_PACKAGE_PATH=export ${GHC_PACKAGE_PATH}:${IHASKELL_GHC_PKG_DB}
${jupyter} notebook

EOF